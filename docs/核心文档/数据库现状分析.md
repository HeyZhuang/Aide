# ğŸ—„ï¸ Jaaz æ•°æ®åº“ç°çŠ¶åˆ†ææŠ¥å‘Š

> **æ›´æ–°æ—¶é—´**: 2025-11-13
> **æ•°æ®åº“ç±»å‹**: SQLite
> **æ•°æ®åº“è·¯å¾„**: `server/user_data/localmanus.db`

---

## ğŸ“Š å½“å‰çŠ¶æ€æ¦‚è§ˆ

### âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨
```
server/user_data/
â”œâ”€â”€ localmanus.db       # 8.8 MB - ä¸»æ•°æ®åº“ âœ… å·²åˆ›å»º
â”œâ”€â”€ templates.db        # 28 KB - æ¨¡æ¿æ•°æ®åº“ âœ… å·²åˆ›å»º
â”œâ”€â”€ fonts.db            # 20 KB - å­—ä½“æ•°æ®åº“ âœ… å·²åˆ›å»º
â”œâ”€â”€ config.toml         # 1 KB - é…ç½®æ–‡ä»¶
â”œâ”€â”€ files/              # ç”Ÿæˆçš„å›¾ç‰‡/è§†é¢‘
â””â”€â”€ font_uploads/       # ä¸Šä¼ çš„å­—ä½“æ–‡ä»¶
```

### âš ï¸ æ•°æ®åº“åˆå§‹åŒ–æœºåˆ¶

**è‡ªåŠ¨è¿ç§»ç³»ç»Ÿ** (`server/services/db_service.py`)
```python
class DatabaseService:
    def __init__(self):
        self.db_path = DB_PATH
        self._ensure_db_directory()
        self._migration_manager = MigrationManager()
        self._init_db()  # å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–

    def _init_db(self):
        """Initialize the database with the current schema"""
        with sqlite3.connect(self.db_path) as conn:
            # åˆ›å»ºç‰ˆæœ¬è¡¨
            conn.execute("""
                CREATE TABLE IF NOT EXISTS db_version (
                    version INTEGER PRIMARY KEY
                )
            """)

            # æ£€æŸ¥å½“å‰ç‰ˆæœ¬
            cursor = conn.execute("SELECT version FROM db_version")
            current_version = cursor.fetchone()
            print('local db version', current_version, 'latest version', CURRENT_VERSION)

            if current_version is None:
                # é¦–æ¬¡å¯åŠ¨ - ä»ç‰ˆæœ¬ 0 å¼€å§‹è¿ç§»
                conn.execute("INSERT INTO db_version (version) VALUES (0)")
                self._migration_manager.migrate(conn, 0, CURRENT_VERSION)
            elif current_version[0] < CURRENT_VERSION:
                # éœ€è¦å‡çº§ - æ‰§è¡Œå¢é‡è¿ç§»
                self._migration_manager.migrate(conn, current_version[0], CURRENT_VERSION)
```

**ç»“è®º**: âœ… æ•°æ®åº“åœ¨åç«¯å¯åŠ¨æ—¶ä¼š**è‡ªåŠ¨åˆ›å»º**å’Œ**è‡ªåŠ¨è¿ç§»**

---

## ğŸ“‹ å·²å®æ–½çš„æ•°æ®åº“è¿ç§» (v1-v7)

### v1: åˆå§‹æ¶æ„ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v1_initial_schema.py`

**åˆ›å»ºçš„è¡¨**:

#### 1. `chat_sessions` - èŠå¤©ä¼šè¯è¡¨
```sql
CREATE TABLE IF NOT EXISTS chat_sessions (
    id TEXT PRIMARY KEY,                  -- ä¼šè¯ID
    canvas_id TEXT,                       -- å…³è”ç”»å¸ƒID
    created_at TEXT DEFAULT (STRFTIME(...)),
    updated_at TEXT DEFAULT (STRFTIME(...)),
    title TEXT,                           -- ä¼šè¯æ ‡é¢˜
    model TEXT,                           -- AIæ¨¡å‹åç§°
    provider TEXT,                        -- AIæä¾›è€…
    FOREIGN KEY (canvas_id) REFERENCES canvases(id)
)

CREATE INDEX idx_chat_sessions_updated_at ON chat_sessions(updated_at DESC, id DESC)
```

#### 2. `chat_messages` - èŠå¤©æ¶ˆæ¯è¡¨
```sql
CREATE TABLE IF NOT EXISTS chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- æ¶ˆæ¯ID
    session_id TEXT,                       -- å…³è”ä¼šè¯ID
    role TEXT,                             -- è§’è‰² (user/assistant)
    message TEXT,                          -- æ¶ˆæ¯å†…å®¹ (JSON)
    created_at TEXT DEFAULT (STRFTIME(...)),
    updated_at TEXT DEFAULT (STRFTIME(...)),
    FOREIGN KEY (session_id) REFERENCES chat_sessions(id)
)

CREATE INDEX idx_chat_messages_session_id_id ON chat_messages(session_id, id)
```

---

### v2: ç”»å¸ƒè¡¨ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v2_add_canvases.py`

#### 3. `canvases` - ç”»å¸ƒè¡¨
```sql
CREATE TABLE IF NOT EXISTS canvases (
    id TEXT PRIMARY KEY,                   -- ç”»å¸ƒID
    name TEXT NOT NULL,                    -- ç”»å¸ƒåç§° (æœ€é•¿30å­—ç¬¦)
    data TEXT,                             -- ç”»å¸ƒæ•°æ® (JSON)
    description TEXT DEFAULT '',           -- ç”»å¸ƒæè¿°
    thumbnail TEXT DEFAULT '',             -- ç¼©ç•¥å›¾URL
    created_at TEXT DEFAULT (STRFTIME(...)),
    updated_at TEXT DEFAULT (STRFTIME(...))
)

CREATE INDEX idx_canvases_updated_at ON canvases(updated_at DESC, id DESC)
```

**é»˜è®¤æ•°æ®**:
```sql
-- åˆ›å»ºé»˜è®¤ç”»å¸ƒ
INSERT OR IGNORE INTO canvases (id, name)
VALUES ('default', 'Default Canvas')

-- å…³è”æ‰€æœ‰æ—§ä¼šè¯åˆ°é»˜è®¤ç”»å¸ƒ
UPDATE chat_sessions
SET canvas_id = 'default'
WHERE canvas_id IS NULL
```

---

### v3: ComfyUI å·¥ä½œæµè¡¨ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v3_add_comfy_workflow.py`

#### 4. `comfy_workflows` - ComfyUI å·¥ä½œæµè¡¨
```sql
CREATE TABLE IF NOT EXISTS comfy_workflows (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- å·¥ä½œæµID
    name TEXT NOT NULL,                    -- å·¥ä½œæµåç§°
    api_json TEXT NOT NULL,                -- ComfyUI API JSON
    description TEXT,                      -- å·¥ä½œæµæè¿°
    inputs TEXT NOT NULL,                  -- è¾“å…¥å‚æ•°é…ç½® (JSON)
    outputs TEXT,                          -- è¾“å‡ºå‚æ•°é…ç½® (JSON)
    created_at TEXT DEFAULT (STRFTIME(...)),
    updated_at TEXT DEFAULT (STRFTIME(...))
)
```

---

### v4: ç”¨æˆ·è®¤è¯è¡¨ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v4_add_users.py`

#### 5. `users` - ç”¨æˆ·è¡¨
```sql
CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY,                   -- ç”¨æˆ·ID
    username TEXT UNIQUE NOT NULL,         -- ç”¨æˆ·å
    email TEXT UNIQUE NOT NULL,            -- é‚®ç®±
    password_hash TEXT NOT NULL,           -- å¯†ç å“ˆå¸Œ (bcrypt)
    image_url TEXT,                        -- å¤´åƒURL
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
)
```

#### 6. `device_codes` - è®¾å¤‡ç è¡¨
```sql
CREATE TABLE IF NOT EXISTS device_codes (
    code TEXT PRIMARY KEY,                 -- è®¾å¤‡ç 
    status TEXT NOT NULL,                  -- çŠ¶æ€ (pending/approved/expired)
    expires_at TEXT NOT NULL,              -- è¿‡æœŸæ—¶é—´
    created_at TEXT NOT NULL,
    user_id TEXT,                          -- å…³è”ç”¨æˆ·ID
    FOREIGN KEY (user_id) REFERENCES users(id)
)

CREATE INDEX idx_device_codes_expires ON device_codes(expires_at)
```

#### 7. `auth_tokens` - è®¤è¯ä»¤ç‰Œè¡¨
```sql
CREATE TABLE IF NOT EXISTS auth_tokens (
    token TEXT PRIMARY KEY,                -- Tokenå­—ç¬¦ä¸²
    user_id TEXT NOT NULL,                 -- å…³è”ç”¨æˆ·ID
    expires_at TEXT NOT NULL,              -- è¿‡æœŸæ—¶é—´
    created_at TEXT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
)

CREATE INDEX idx_auth_tokens_user ON auth_tokens(user_id)
CREATE INDEX idx_auth_tokens_expires ON auth_tokens(expires_at)
```

**âš ï¸ TODO**: åç»­å¯ä»¥è½¬ Redis (é«˜å¹¶å‘åœºæ™¯)

---

### v5: Google OAuth å­—æ®µ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v5_add_google_auth.py`

**ä¿®æ”¹çš„è¡¨**: `users`

**æ–°å¢å­—æ®µ**:
```sql
ALTER TABLE users ADD COLUMN google_id TEXT UNIQUE;       -- Google ID
ALTER TABLE users ADD COLUMN provider TEXT DEFAULT 'local'; -- è®¤è¯æä¾›è€…
```

**æ›´æ–°é»˜è®¤å€¼**:
```sql
UPDATE users SET provider = 'local' WHERE provider IS NULL;
```

---

### v6: ç”»å¸ƒç”¨æˆ·å…³è” âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v6_add_user_id_to_canvases.py`

**ä¿®æ”¹çš„è¡¨**: `canvases`

**æ–°å¢å­—æ®µ**:
```sql
ALTER TABLE canvases ADD COLUMN user_id TEXT REFERENCES users(id);
```

**é»˜è®¤æ•°æ®**:
```sql
-- åˆ›å»ºé»˜è®¤ç”¨æˆ· (å¦‚æœä¸å­˜åœ¨)
INSERT OR IGNORE INTO users (id, username, email, password_hash, created_at, updated_at)
VALUES (
    'default_user',
    'default',
    'default@jaaz.local',
    'default_hash',
    STRFTIME('%Y-%m-%dT%H:%M:%fZ', 'now'),
    STRFTIME('%Y-%m-%dT%H:%M:%fZ', 'now')
);

-- å…³è”æ‰€æœ‰æ—§ç”»å¸ƒåˆ°é»˜è®¤ç”¨æˆ·
UPDATE canvases
SET user_id = 'default_user'
WHERE user_id IS NULL;
```

---

### v7: ç”¨æˆ·è§’è‰²å­—æ®µ âœ… å·²å®æ–½

**è¿ç§»æ–‡ä»¶**: `server/services/migrations/v7_add_user_role.py`

**ä¿®æ”¹çš„è¡¨**: `users`

**æ–°å¢å­—æ®µ**:
```sql
ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'viewer';
```

**è§’è‰²ç±»å‹**:
- `admin` - ç®¡ç†å‘˜ (å…¨éƒ¨æƒé™)
- `editor` - ç¼–è¾‘è€… (åˆ›å»º/ç¼–è¾‘ç”»å¸ƒ)
- `viewer` - æŸ¥çœ‹è€… (åªè¯»)

**æ›´æ–°é»˜è®¤å€¼**:
```sql
UPDATE users SET role = 'viewer' WHERE role IS NULL;
```

---

### âŒ v8: æ¨¡æ¿è¡¨ (æœªå®æ–½)

**è¿ç§»æ–‡ä»¶**: `v8_create_templates_table.py` - **æ–‡ä»¶ä¸å­˜åœ¨**

**é—®é¢˜**:
```python
# server/services/migrations/manager.py
# from services.migrations.v8_create_templates_table import V8CreateTemplatesTable  # å·²æ³¨é‡Š

CURRENT_VERSION = 7  # æš‚æ—¶é™å›7ï¼Œå› ä¸ºv8è¿ç§»æ–‡ä»¶å·²åˆ é™¤
```

**å½±å“**:
- `template_router.py` æ‰€æœ‰ç«¯ç‚¹è¿”å›ç©ºåˆ—è¡¨æˆ– 503 é”™è¯¯
- å‰ç«¯æ¨¡æ¿é¡µé¢æ˜¾ç¤ºç©ºåˆ—è¡¨
- ä½†æœ‰ç‹¬ç«‹çš„ `templates.db` æ•°æ®åº“æ–‡ä»¶ (28 KB)

**è§£å†³æ–¹æ¡ˆ**: è§ [é¡¹ç›®è§„åˆ’.md](./é¡¹ç›®è§„åˆ’.md) Phase 1.1

---

## ğŸ“ æ•°æ®åº“å†™å…¥å®ç°æƒ…å†µ

### âœ… å·²å®ç°çš„å†™å…¥æ“ä½œ

#### 1. ç”»å¸ƒç®¡ç† âœ… å®Œæ•´å®ç°

**åˆ›å»ºç”»å¸ƒ** (`db_service.py:49`)
```python
async def create_canvas(self, id: str, name: str, user_id: str):
    """åˆ›å»ºæ–°ç”»å¸ƒï¼Œå…³è”åˆ°ç”¨æˆ·"""
    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("""
            INSERT INTO canvases (id, name, user_id)
            VALUES (?, ?, ?)
        """, (id, name, user_id))
        await db.commit()
```

**ä¿å­˜ç”»å¸ƒæ•°æ®** (`db_service.py:185`)
```python
async def save_canvas_data(self, id: str, data: str, thumbnail: Optional[str] = None):
    """ä¿å­˜ç”»å¸ƒæ•°æ®"""
    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("""
            UPDATE canvases
            SET data = ?, thumbnail = ?, updated_at = STRFTIME(...)
            WHERE id = ?
        """, (data, thumbnail, id))
        await db.commit()
```

**é‡å‘½åç”»å¸ƒ** (`db_service.py:258`)
```python
async def rename_canvas(self, id: str, name: str):
    """é‡å‘½åç”»å¸ƒ"""
    # éªŒè¯ç”»å¸ƒåç§°é•¿åº¦ (1-30å­—ç¬¦)
    if not name or len(name) > 30:
        raise ValueError(f"ç”»å¸ƒåç§°é•¿åº¦å¿…é¡»åœ¨1-30å­—ç¬¦ä¹‹é—´")

    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("UPDATE canvases SET name = ? WHERE id = ?", (name, id))
        await db.commit()
```

**åˆ é™¤ç”»å¸ƒ** (`db_service.py:246`)
```python
async def delete_canvas(self, id: str):
    """Delete canvas and related data"""
    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("DELETE FROM canvases WHERE id = ?", (id,))
        await db.commit()
```

---

#### 2. èŠå¤©ä¼šè¯ç®¡ç† âœ… å®Œæ•´å®ç°

**åˆ›å»ºä¼šè¯** (`db_service.py:111`)
```python
async def create_chat_session(self, id: str, model: str, provider: str, canvas_id: str, title: Optional[str] = None):
    """ä¿å­˜æ–°çš„èŠå¤©ä¼šè¯"""
    # éªŒè¯å­—æ®µé•¿åº¦
    if model and len(model) > 30:
        raise ValueError(f"AIæ¨¡å‹åç§°æœ€é•¿30å­—ç¬¦")
    if provider and len(provider) > 30:
        raise ValueError(f"AIæœåŠ¡æä¾›è€…åç§°æœ€é•¿30å­—ç¬¦")

    # ä¼šè¯æ ‡é¢˜è¶…é•¿æ—¶è‡ªåŠ¨æˆªå–å‰200å­—ç¬¦
    if title and len(title) > 200:
        title = title[:200]

    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("""
            INSERT INTO chat_sessions (id, model, provider, canvas_id, title)
            VALUES (?, ?, ?, ?, ?)
        """, (id, model, provider, canvas_id, title))
        await db.commit()
```

**ä¿å­˜æ¶ˆæ¯** (`db_service.py:132`)
```python
async def create_message(self, session_id: str, role: str, message: str):
    """Save a chat message"""
    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("""
            INSERT INTO chat_messages (session_id, role, message)
            VALUES (?, ?, ?)
        """, (session_id, role, message))
        await db.commit()
```

---

#### 3. ç”¨æˆ·è®¤è¯ âœ… å®Œæ•´å®ç°

**åˆ›å»ºç”¨æˆ·** (`auth_service.py:35`)
```python
async def create_user(self, username: str, email: str, password: str, provider: str = "local", google_id: Optional[str] = None, image_url: Optional[str] = None, role: str = "viewer") -> Dict[str, Any]:
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    user_id = nanoid.generate()
    password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            INSERT INTO users (id, username, email, password_hash, google_id, provider, image_url, role, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (user_id, username, email, password_hash, google_id, provider, image_url, role, now, now))
        await db.commit()

    return {"id": user_id, "username": username, "email": email}
```

**åˆ›å»º Token** (`auth_service.py:316`)
```python
async def create_token(self, user_id: str) -> str:
    """åˆ›å»ºè®¤è¯ä»¤ç‰Œ"""
    token = secrets.token_urlsafe(32)
    expires_at = datetime.now() + timedelta(days=30)

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            INSERT INTO auth_tokens (token, user_id, expires_at, created_at)
            VALUES (?, ?, ?, ?)
        """, (token, user_id, expires_at.isoformat(), datetime.now().isoformat()))
        await db.commit()

    return token
```

---

#### 4. ComfyUI å·¥ä½œæµ âœ… å®Œæ•´å®ç°

**åˆ›å»ºå·¥ä½œæµ** (`db_service.py:275`)
```python
async def create_comfy_workflow(self, name: str, api_json: str, description: str, inputs: str, outputs: Optional[str] = None):
    """Create a new comfy workflow"""
    async with aiosqlite.connect(self.db_path) as db:
        await db.execute("""
            INSERT INTO comfy_workflows (name, api_json, description, inputs, outputs)
            VALUES (?, ?, ?, ?, ?)
        """, (name, api_json, description, inputs, outputs))
        await db.commit()
```

---

### âŒ æœªå®ç°çš„å†™å…¥æ“ä½œ

#### 1. æ¨¡æ¿ç®¡ç† âŒ å®Œå…¨ç¦ç”¨

**åŸå› **: `templates` è¡¨ä¸å­˜åœ¨ (v8 è¿ç§»æœªå®æ–½)

**ä¸´æ—¶çŠ¶æ€**:
```python
# server/routers/template_router.py
@router.get("/api/templates")
async def list_templates():
    # TODO: [æ•°æ®åº“è¿ç§»] ä¸´æ—¶ç¦ç”¨æ¨¡æ¿åŠŸèƒ½
    return []  # è¿”å›ç©ºåˆ—è¡¨
```

**å½±å“èŒƒå›´**:
- åˆ›å»ºæ¨¡æ¿ âŒ
- æ›´æ–°æ¨¡æ¿ âŒ
- åˆ é™¤æ¨¡æ¿ âŒ
- ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶ âŒ

---

## ğŸ”— å‰åç«¯è”è°ƒç°çŠ¶

### âœ… æ­£å¸¸å·¥ä½œçš„æ¥å£

#### 1. ç”»å¸ƒæ¥å£ âœ… å®Œå…¨æ­£å¸¸

**å‰ç«¯è°ƒç”¨** (`react/src/api/canvas.ts`)
```typescript
export const listCanvases = async (): Promise<Canvas[]> => {
  const response = await fetch('/api/canvases')
  return response.json()
}

export const createCanvas = async (name: string) => {
  const response = await fetch('/api/canvases', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  })
  return response.json()
}

export const saveCanvas = async (id: string, data: any) => {
  await fetch(`/api/canvases/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ data })
  })
}
```

**åç«¯å®ç°** (`server/routers/canvas.py`)
```python
@router.get("/api/canvases")
async def list_canvases(current_user: Optional[dict] = Depends(get_current_user_optional)):
    """åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰ç”»å¸ƒ"""
    user_id = current_user['id'] if current_user else 'default_user'
    canvases = await db_service.list_canvases(user_id)
    return canvases

@router.post("/api/canvases")
async def create_canvas(request: dict, current_user: Optional[dict] = Depends(get_current_user_optional)):
    """åˆ›å»ºæ–°ç”»å¸ƒ"""
    user_id = current_user['id'] if current_user else 'default_user'
    canvas_id = nanoid.generate()
    await db_service.create_canvas(canvas_id, request['name'], user_id)
    return {"id": canvas_id, "name": request['name']}

@router.put("/api/canvases/{id}")
async def save_canvas(id: str, request: dict):
    """ä¿å­˜ç”»å¸ƒæ•°æ®"""
    await db_service.save_canvas_data(id, json.dumps(request['data']))
    return {"success": True}
```

**è”è°ƒçŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸
- å‰ç«¯å¯ä»¥è·å–ç”»å¸ƒåˆ—è¡¨
- å‰ç«¯å¯ä»¥åˆ›å»ºæ–°ç”»å¸ƒ
- å‰ç«¯å¯ä»¥ä¿å­˜ç”»å¸ƒæ•°æ®
- å‰ç«¯å¯ä»¥åˆ é™¤ç”»å¸ƒ

**æµ‹è¯•æ•°æ®æµ**:
```
å‰ç«¯ CanvasList.tsx
  â†“ useQuery(['canvases'], listCanvases)
  â†“ GET /api/canvases
åç«¯ canvas.py:list_canvases()
  â†“ db_service.list_canvases(user_id)
  â†“ SELECT * FROM canvases WHERE user_id = ?
æ•°æ®åº“ localmanus.db
  â†“ è¿”å›ç”»å¸ƒåˆ—è¡¨
å‰ç«¯æ˜¾ç¤º
```

---

#### 2. èŠå¤©æ¥å£ âœ… æ­£å¸¸å·¥ä½œ

**å‰ç«¯è°ƒç”¨** (`react/src/components/chat/Chat.tsx`)
```typescript
const handleSendMessage = async () => {
  // å‘é€æ¶ˆæ¯åˆ°åç«¯
  socket?.emit('chat', {
    messages: [...messages, { role: 'user', content: input }],
    canvas_id: canvasId,
    session_id: currentSessionId,
  })
}

// ç›‘å¬åç«¯å“åº”
socket?.on('message', (data) => {
  if (data.type === 'all_messages') {
    setMessages(data.messages)
  }
})
```

**åç«¯å®ç°** (`server/routers/chat_router.py`)
```python
@sio.on('chat')
async def handle_chat(sid, data):
    """å¤„ç†èŠå¤©è¯·æ±‚"""
    messages = data.get('messages', [])
    canvas_id = data.get('canvas_id')
    session_id = data.get('session_id') or nanoid.generate()

    # ä¿å­˜ä¼šè¯åˆ°æ•°æ®åº“
    await db_service.create_chat_session(session_id, model, provider, canvas_id)

    # è°ƒç”¨ LangGraph ç”Ÿæˆå“åº”
    response = await chat_service.handle_chat(data)

    # ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    for msg in messages:
        await db_service.create_message(session_id, msg['role'], json.dumps(msg))

    # é€šè¿‡ WebSocket è¿”å›ç»“æœ
    await sio.emit('message', {'type': 'all_messages', 'messages': response}, room=sid)
```

**è”è°ƒçŠ¶æ€**: âœ… æ­£å¸¸å·¥ä½œ
- å‰ç«¯å‘é€æ¶ˆæ¯ â†’ åç«¯æ¥æ”¶
- åç«¯è°ƒç”¨ AI â†’ è¿”å›ç»“æœ
- æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ âœ…
- WebSocket å®æ—¶é€šä¿¡ âœ…

---

#### 3. ç”¨æˆ·è®¤è¯æ¥å£ âœ… æ­£å¸¸å·¥ä½œ

**å‰ç«¯è°ƒç”¨** (`react/src/api/auth.ts`)
```typescript
export const loginWithPassword = async (username: string, password: string) => {
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  })
  return response.json()
}
```

**åç«¯å®ç°** (`server/routers/auth_router.py`)
```python
@router.post("/api/auth/login")
async def login(request: dict):
    """ç”¨æˆ·ç™»å½•"""
    username = request['username']
    password = request['password']

    user = await auth_service.verify_password(username, password)
    if not user:
        raise HTTPException(401, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

    token = await auth_service.create_token(user['id'])
    return {"token": token, "user": user}
```

**è”è°ƒçŠ¶æ€**: âœ… æ­£å¸¸å·¥ä½œ
- æœ¬åœ°è´¦å·ç™»å½• âœ…
- Google OAuth ç™»å½• âœ…
- Token è®¤è¯ âœ…

---

### âš ï¸ éƒ¨åˆ†å·¥ä½œçš„æ¥å£

#### 1. æ¨¡æ¿æ¥å£ âš ï¸ è¿”å›ç©ºæ•°æ®

**å‰ç«¯è°ƒç”¨** (`react/src/components/admin/TemplateList.tsx`)
```typescript
const { data: templates } = useQuery({
  queryKey: ['templates'],
  queryFn: async () => {
    const response = await fetch('/api/templates')
    return response.json()
  }
})
```

**åç«¯å®ç°** (`server/routers/template_router.py`)
```python
@router.get("/api/templates")
async def list_templates():
    # TODO: [æ•°æ®åº“è¿ç§»] ä¸´æ—¶ç¦ç”¨æ¨¡æ¿åŠŸèƒ½
    return []  # è¿”å›ç©ºåˆ—è¡¨ï¼Œå‰ç«¯ä¸æŠ¥é”™ä½†æ˜¾ç¤ºç©º
```

**è”è°ƒçŠ¶æ€**: âš ï¸ éƒ¨åˆ†æ­£å¸¸
- æ¥å£ä¸æŠ¥é”™ âœ…
- è¿”å›ç©ºåˆ—è¡¨ âœ…
- ä½†æ— æ³•åˆ›å»º/ç¼–è¾‘æ¨¡æ¿ âŒ

---

### âŒ ä¸å·¥ä½œçš„æ¥å£

ç›®å‰**æ²¡æœ‰å®Œå…¨ä¸å·¥ä½œçš„æ¥å£**ï¼Œæ‰€æœ‰ç«¯ç‚¹éƒ½æœ‰å“åº”ã€‚

---

## ğŸ“Š æ•°æ®åº“è¿æ¥æµ‹è¯•

### æµ‹è¯•æ–¹æ³• 1: æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
```powershell
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls server/user_data/localmanus.db

# è¾“å‡º:
# -rw-r--r-- 1 lucky 197121 8822784 11æœˆ 13 19:08 localmanus.db
```
**ç»“æœ**: âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ (8.8 MB)

---

### æµ‹è¯•æ–¹æ³• 2: å¯åŠ¨åç«¯æŸ¥çœ‹æ—¥å¿—
```powershell
cd server
python main.py
```

**é¢„æœŸæ—¥å¿—**:
```
local db version (7,) latest version 7
âœ… Database is up to date (version 7)
âœ… å·¥å…·æœåŠ¡åˆå§‹åŒ–å®Œæˆ
âœ… æœåŠ¡å™¨å¯åŠ¨å®Œæˆ
```

**å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨**:
```
local db version None latest version 7
ğŸ”„ Migrating database from version 0 to 7
âœ… Applied migration v1: Initial schema
âœ… Applied migration v2: Add canvases
...
âœ… Applied migration v7: Add user role
```

---

### æµ‹è¯•æ–¹æ³• 3: å‰ç«¯æµ‹è¯•ç”»å¸ƒåˆ—è¡¨
```typescript
// react/src/components/home/CanvasList.tsx
const { data: canvases } = useQuery({
  queryKey: ['canvases'],
  queryFn: listCanvases,
})

// å¦‚æœè¿”å›æ•°æ®ï¼Œè¯´æ˜æ•°æ®åº“è¿æ¥æ­£å¸¸
```

**é¢„æœŸç»“æœ**:
- ç©ºåˆ—è¡¨ `[]` - æ•°æ®åº“æ­£å¸¸ä½†æ— æ•°æ®
- éç©ºåˆ—è¡¨ - æ•°æ®åº“æ­£å¸¸ä¸”æœ‰æ•°æ®
- æŠ¥é”™ - æ•°æ®åº“è¿æ¥å¤±è´¥

---

## ğŸ¯ ç»“è®º

### âœ… å·²å®Œæˆçš„éƒ¨åˆ†

1. **æ•°æ®åº“åˆå§‹åŒ–** âœ…
   - è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æ–‡ä»¶
   - è‡ªåŠ¨æ‰§è¡Œè¿ç§» (v1-v7)
   - é»˜è®¤æ•°æ®æ’å…¥

2. **æ•°æ®å†™å…¥åŠŸèƒ½** âœ…
   - ç”»å¸ƒç®¡ç† (åˆ›å»º/ä¿å­˜/åˆ é™¤/é‡å‘½å)
   - èŠå¤©ä¼šè¯ (åˆ›å»º/ä¿å­˜æ¶ˆæ¯)
   - ç”¨æˆ·è®¤è¯ (åˆ›å»ºç”¨æˆ·/åˆ›å»ºToken)
   - ComfyUI å·¥ä½œæµ

3. **å‰åç«¯è”è°ƒ** âœ…
   - ç”»å¸ƒæ¥å£ 100% æ­£å¸¸
   - èŠå¤©æ¥å£ 100% æ­£å¸¸
   - ç”¨æˆ·è®¤è¯æ¥å£ 100% æ­£å¸¸
   - WebSocket é€šä¿¡æ­£å¸¸

---

### âš ï¸ å­˜åœ¨çš„é—®é¢˜

1. **æ¨¡æ¿åŠŸèƒ½ç¦ç”¨** âš ï¸
   - `templates` è¡¨ä¸å­˜åœ¨
   - æ‰€æœ‰æ¨¡æ¿æ¥å£è¿”å›ç©ºæ•°æ®
   - ä½†æœ‰ç‹¬ç«‹çš„ `templates.db` æ–‡ä»¶

2. **æ•°æ®åº“æ€§èƒ½** âš ï¸
   - Token å­˜å‚¨åœ¨ SQLite (å»ºè®®è¿ç§»åˆ° Redis)
   - å¤§é‡å¹¶å‘å†™å…¥å¯èƒ½æ€§èƒ½ä¸ä½³

---

### ğŸ“‹ å¾…åŠäº‹é¡¹

1. **ç«‹å³ä¿®å¤** (Phase 1)
   - åˆ›å»º v8 è¿ç§»æ–‡ä»¶æ¢å¤æ¨¡æ¿åŠŸèƒ½
   - å‚è€ƒ [é¡¹ç›®è§„åˆ’.md](./é¡¹ç›®è§„åˆ’.md)

2. **æ€§èƒ½ä¼˜åŒ–** (Phase 2-3)
   - è¿ç§» Token åˆ° Redis
   - æ·»åŠ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
   - å¢åŠ æ•°æ®åº“è¿æ¥æ± 

---

*æœ€åæ›´æ–°: 2025-11-13*
