# PSD Canvas Jaaz 项目代码分析报告

## 📋 项目概述

**PSD Canvas Jaaz** 是一个开源的AI驱动的创意设计工具，类似于Canva的本地替代方案。它是一个全栈应用，支持图像生成、视频生成、PSD文件处理、无限画布编辑等功能。

### 核心定位
- **开源Canva AI替代方案**
- **本地优先，保护隐私**
- **多模态AI助手**（支持图像、视频、PSD处理）
- **跨平台桌面应用**（Windows、macOS、Linux）

---

## 🏗️ 技术架构

### 1. 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    Electron 桌面应用                      │
│  ┌──────────────────────────────────────────────────┐  │
│  │         React 前端 (Vite + TypeScript)            │  │
│  │  - TanStack Router (路由)                         │  │
│  │  - Zustand (状态管理)                              │  │
│  │  - React Query (数据获取)                          │  │
│  │  - Socket.IO Client (实时通信)                    │  │
│  └──────────────────────────────────────────────────┘  │
│                          ↕                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │      FastAPI 后端 (Python 3.12+)                  │  │
│  │  - Socket.IO Server (WebSocket)                   │  │
│  │  - SQLite 数据库 (本地存储)                        │  │
│  │  - LangGraph (AI Agent)                           │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2. 技术栈详情

#### 前端技术栈
- **框架**: React 19.1.0
- **构建工具**: Vite 6.2.0
- **路由**: TanStack Router 1.120.15
- **状态管理**: Zustand 5.0.5
- **数据获取**: TanStack React Query 5.80.3
- **UI组件库**: Radix UI + Tailwind CSS 4.1.16
- **画布编辑**: Excalidraw 0.18.0, Tldraw 3.13.1
- **实时通信**: Socket.IO Client 4.8.1
- **国际化**: i18next 25.2.1 (支持中文、英文)

#### 后端技术栈
- **框架**: FastAPI
- **ASGI服务器**: Uvicorn
- **数据库**: SQLite (通过 aiosqlite)
- **AI框架**: 
  - LangGraph 0.4.8 (多Agent系统)
  - LangChain (Ollama、OpenAI集成)
  - Google Gemini API (PSD智能处理)
- **图像处理**: 
  - Pillow (图像处理)
  - psd-tools (PSD文件解析)
  - numpy (图像计算)
- **实时通信**: python-socketio 5.13.0

#### 桌面应用
- **框架**: Electron 35.1.0
- **构建工具**: Electron Builder 24.0.0
- **进程管理**: 支持ComfyUI本地运行

---

## 📁 项目结构

### 目录结构

```
psd-canvas-jaaz/
├── server/                    # 后端服务
│   ├── main.py               # FastAPI应用入口
│   ├── routers/              # API路由
│   │   ├── auth_router.py   # 认证路由
│   │   ├── chat_router.py   # 聊天路由
│   │   ├── canvas.py        # 画布路由
│   │   ├── image_router.py  # 图像生成路由
│   │   ├── psd_router.py    # PSD处理路由
│   │   ├── template_router.py # 模板路由
│   │   └── ...
│   ├── services/            # 业务逻辑服务
│   │   ├── auth_service.py  # 认证服务
│   │   ├── chat_service.py # 聊天服务
│   │   ├── db_service.py   # 数据库服务
│   │   ├── langgraph_service/ # AI Agent服务
│   │   ├── gemini_psd_resize_service.py # PSD智能缩放
│   │   └── ...
│   ├── tools/              # AI工具集成
│   │   ├── image_providers/ # 图像生成提供商
│   │   ├── video_providers/ # 视频生成提供商
│   │   └── ...
│   ├── models/             # 数据模型
│   ├── utils/             # 工具函数
│   └── requirements.txt   # Python依赖
│
├── react/                  # 前端应用
│   ├── src/
│   │   ├── main.tsx       # React入口
│   │   ├── App.tsx        # 主应用组件
│   │   ├── routes/        # 路由页面
│   │   │   ├── index.tsx # 首页
│   │   │   ├── canvas.$id.tsx # 画布页面
│   │   │   ├── agent_studio.tsx # AI工作室
│   │   │   └── ...
│   │   ├── components/    # React组件
│   │   │   ├── canvas/   # 画布组件
│   │   │   ├── chat/     # 聊天组件
│   │   │   ├── auth/     # 认证组件
│   │   │   └── ...
│   │   ├── api/          # API调用
│   │   ├── stores/       # Zustand状态管理
│   │   ├── hooks/        # React Hooks
│   │   └── lib/          # 工具库
│   └── package.json
│
├── electron/              # Electron桌面应用
│   ├── main.js           # Electron主进程
│   ├── preload.js        # 预加载脚本
│   └── ...
│
└── package.json          # 根package.json
```

---

## 🔑 核心功能模块

### 1. 认证系统 (`auth_service.py`, `auth_router.py`)

**功能特性**:
- ✅ 用户注册/登录
- ✅ 设备码认证流程
- ✅ Token管理（7天有效期）
- ✅ 密码哈希（SHA-256）
- ✅ 自动注册功能（测试模式）

**数据库表**:
- `users`: 用户信息
- `device_codes`: 设备认证码
- `auth_tokens`: 访问令牌

**API端点**:
- `POST /api/device/auth` - 创建设备码
- `GET /auth/device?code=xxx` - 登录页面
- `POST /api/device/authorize` - 授权设备
- `GET /api/device/poll` - 轮询认证状态
- `POST /api/auth/login` - 用户名密码登录
- `POST /api/auth/register` - 用户注册

### 2. 聊天与AI Agent系统 (`chat_service.py`, `langgraph_service/`)

**功能特性**:
- ✅ 多轮对话
- ✅ 流式响应（WebSocket）
- ✅ 多Agent协作（LangGraph）
- ✅ 工具调用（图像/视频生成）
- ✅ 会话管理

**工作流程**:
1. 前端发送消息 → `POST /api/chat`
2. 保存消息到数据库
3. 启动LangGraph Agent任务
4. Agent调用工具（图像/视频生成）
5. 通过WebSocket实时推送结果
6. 完成后通知前端

**支持的AI模型**:
- 文本模型: GPT-4o, Claude, Gemini, Ollama
- 图像生成: Midjourney, Flux, Recraft, Imagen等
- 视频生成: VEO3, Kling, Seedance等

### 3. 画布系统 (`canvas.py`, `canvas_layer_arrangement_service.py`)

**功能特性**:
- ✅ 无限画布（Excalidraw）
- ✅ 图层管理
- ✅ 智能排列（Gemini 2.5 Pro驱动）
- ✅ 自动缩放
- ✅ 实时协作（WebSocket）

**智能排列功能**:
- 使用Gemini 2.5 Pro分析图层
- 自动调整位置和尺寸
- 保持视觉平衡
- 支持预设尺寸（Instagram、Facebook等）

### 4. PSD处理系统 (`psd_router.py`, `gemini_psd_resize_service.py`)

**功能特性**:
- ✅ PSD文件解析（psd-tools）
- ✅ 图层提取和预览
- ✅ 智能缩放（Gemini 2.5 Pro）
- ✅ 图层信息提取
- ✅ PSD重建和渲染

**智能缩放流程**:
1. 解析PSD文件，提取图层信息
2. 使用Gemini 2.5 Pro分析图层
3. 生成缩放参数（位置、尺寸）
4. 应用变换到图层
5. 重建PSD文件
6. 返回预览或下载

**API端点**:
- `POST /api/psd/upload` - 上传PSD文件
- `POST /api/psd/resize/auto-resize` - 自动缩放
- `POST /api/psd/resize/preview-resize` - 预览缩放
- `GET /api/psd/{psd_id}/layers` - 获取图层列表

### 5. 模板系统 (`template_router.py`)

**功能特性**:
- ✅ 模板创建和保存
- ✅ 模板预览
- ✅ 模板应用
- ✅ 自动保存功能

### 6. 图像/视频生成系统 (`image_router.py`, `tools/`)

**功能特性**:
- ✅ 多提供商支持（Jaaz、Replicate、Volces、ComfyUI等）
- ✅ 统一接口抽象
- ✅ 异步生成
- ✅ 进度跟踪（WebSocket）

**支持的提供商**:
- **图像**: OpenAI, Midjourney, Flux, Recraft, Imagen, Doubao等
- **视频**: VEO3, Kling, Seedance, Hailuo等

### 7. WebSocket实时通信 (`websocket_service.py`, `websocket_router.py`)

**功能特性**:
- ✅ 实时消息推送
- ✅ 流式响应
- ✅ 任务状态更新
- ✅ 画布协作

**事件类型**:
- `message`: 聊天消息
- `tool_result`: 工具执行结果
- `done`: 任务完成
- `error`: 错误信息

---

## 🗄️ 数据库设计

### 数据库迁移系统 (`services/migrations/`)

**版本管理**:
- `v1_initial_schema.py`: 初始schema（chat_sessions, chat_messages）
- `v2_add_canvases.py`: 添加画布表
- `v3_add_comfy_workflow.py`: 添加ComfyUI工作流
- `v4_add_users.py`: 添加用户认证表

**核心表结构**:

1. **canvases** - 画布表
   - id, name, description, thumbnail, created_at, updated_at

2. **chat_sessions** - 聊天会话
   - id, model, provider, canvas_id, title, created_at, updated_at

3. **chat_messages** - 聊天消息
   - id, session_id, role, message, created_at

4. **users** - 用户表
   - id, username, email, password_hash, image_url, created_at, updated_at

5. **device_codes** - 设备码表
   - code, user_id, device_info, expires_at

6. **auth_tokens** - Token表
   - token, user_id, expires_at, created_at

---

## 🔌 API接口概览

### 认证相关
- `POST /api/device/auth` - 创建设备码
- `GET /auth/device` - 登录页面
- `POST /api/device/authorize` - 授权设备
- `GET /api/device/poll` - 轮询认证状态
- `POST /api/auth/login` - 登录
- `POST /api/auth/register` - 注册
- `POST /api/auth/logout` - 登出

### 聊天相关
- `POST /api/chat` - 发送聊天消息
- `POST /api/cancel/{session_id}` - 取消聊天
- `POST /api/magic` - Magic生成
- `POST /api/magic/cancel/{session_id}` - 取消Magic

### 画布相关
- `GET /api/canvas` - 获取画布列表
- `POST /api/canvas` - 创建画布
- `GET /api/canvas/{canvas_id}` - 获取画布详情
- `PUT /api/canvas/{canvas_id}` - 更新画布
- `DELETE /api/canvas/{canvas_id}` - 删除画布
- `POST /api/psd/arrange-layers` - 智能排列图层

### PSD相关
- `POST /api/psd/upload` - 上传PSD
- `POST /api/psd/resize/auto-resize` - 自动缩放
- `POST /api/psd/resize/preview-resize` - 预览缩放
- `GET /api/psd/{psd_id}/layers` - 获取图层

### 模板相关
- `GET /api/templates` - 获取模板列表
- `POST /api/templates` - 创建模板
- `GET /api/templates/{template_id}` - 获取模板详情
- `PUT /api/templates/{template_id}` - 更新模板
- `DELETE /api/templates/{template_id}` - 删除模板

### 配置相关
- `GET /api/config` - 获取配置
- `POST /api/config` - 更新配置
- `GET /api/config/exists` - 检查配置是否存在

---

## 🔄 数据流和状态管理

### 前端状态管理 (Zustand)

**主要Store**:
- `stores/canvas.ts` - 画布状态
- `stores/configs.ts` - 配置状态

### 数据获取 (React Query)

- 使用IndexedDB持久化缓存
- 自动缓存管理
- 乐观更新支持

### WebSocket通信流程

```
前端                   后端
 │                      │
 │── WebSocket连接 ────>│
 │                      │
 │<── 连接确认 ──────────│
 │                      │
 │── 发送消息 ─────────>│
 │                      │──> 处理消息
 │                      │──> 调用AI Agent
 │                      │──> 执行工具
 │<── 流式响应 ─────────│
 │<── 工具结果 ─────────│
 │<── 完成通知 ─────────│
```

---

## 🛠️ 开发环境配置

### 环境要求
- **Python**: >= 3.12
- **Node.js**: (查看package.json)
- **数据库**: SQLite (自动创建)

### 启动步骤

1. **安装前端依赖**:
```bash
cd react
npm install --force
```

2. **安装后端依赖**:
```bash
cd server
pip install -r requirements.txt
```

3. **启动开发服务器**:
```bash
# 前端
cd react
npm run dev

# 后端
cd server
python main.py
```

4. **启动Electron应用**:
```bash
npm run dev
```

### 环境变量

**前端** (`.env`):
- `VITE_PUBLIC_POSTHOG_HOST` - PostHog分析
- `VITE_PUBLIC_POSTHOG_KEY` - PostHog密钥

**后端**:
- `UI_DIST_DIR` - React构建目录路径
- API密钥通过配置服务管理

---

## 🔐 安全特性

1. **认证系统**:
   - Token-based认证
   - 设备码流程
   - 密码哈希（SHA-256）

2. **CORS配置**:
   - 限制允许的源
   - 支持开发和生产环境

3. **数据隐私**:
   - 本地优先存储
   - SQLite本地数据库
   - 无外部数据追踪

---

## 📊 关键设计模式

### 1. 服务层模式
- 业务逻辑封装在`services/`目录
- 路由层只负责请求/响应处理

### 2. 提供者模式
- 图像/视频生成使用统一的Provider接口
- 易于扩展新的提供商

### 3. 迁移系统
- 数据库版本管理
- 自动迁移支持

### 4. 流式处理
- 使用WebSocket实现实时通信
- 支持任务取消

---

## 🚀 扩展建议

### 1. 添加新功能时的注意事项

**后端扩展**:
1. 在`routers/`创建新路由文件
2. 在`services/`实现业务逻辑
3. 在`main.py`注册路由
4. 如需新表，创建迁移文件

**前端扩展**:
1. 在`routes/`创建新路由页面
2. 在`components/`创建组件
3. 在`api/`添加API调用函数
4. 如需状态管理，在`stores/`添加store

### 2. 添加新的AI提供商

1. 在`tools/image_providers/`或`tools/video_providers/`创建Provider类
2. 实现`image_base_provider.py`或`video_base_provider.py`的接口
3. 在`tool_service.py`注册Provider
4. 在配置中添加模型配置

### 3. 数据库迁移

1. 在`services/migrations/`创建新迁移文件
2. 更新`CURRENT_VERSION`
3. 实现`up()`和`down()`方法
4. 迁移系统会自动执行

---

## ⚠️ 已知问题和注意事项

1. **PSD工具依赖**: PSD相关功能需要`psd-tools`，如果环境不支持会自动跳过
2. **自动注册**: 认证系统在测试模式下支持自动注册，生产环境需要关闭
3. **ComfyUI**: 需要本地安装ComfyUI才能使用本地图像生成
4. **API密钥**: 需要配置相应的API密钥才能使用AI功能

---

## 📝 代码质量

### 代码规范
- **Python**: 使用Black格式化，Ruff检查
- **TypeScript**: ESLint + TypeScript严格模式
- **配置**: `pyproject.toml`, `.prettierrc.json`

### 日志系统
- 使用`utils/logger.py`统一日志
- 支持不同日志级别
- 结构化日志输出

---

## 🎯 总结

这是一个**架构清晰、功能完整**的全栈应用，具有以下优势：

✅ **模块化设计**: 清晰的目录结构和职责分离  
✅ **可扩展性**: 易于添加新功能和提供商  
✅ **实时通信**: WebSocket支持实时交互  
✅ **本地优先**: 保护用户隐私和数据安全  
✅ **多模态AI**: 支持图像、视频、PSD等多种格式  
✅ **跨平台**: Electron支持多平台部署  

**适合场景**:
- AI驱动的设计工具
- 创意内容生成平台
- 本地化设计应用
- 多模态AI助手

---

*报告生成时间: 2025年*  
*项目版本: 1.0.30*

