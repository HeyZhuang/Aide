# ç”¨æˆ·ä¸ªäººç®¡ç†ç³»ç»Ÿ API æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è§ˆ

æœ¬ç³»ç»Ÿæä¾›å®Œæ•´çš„ç”¨æˆ·ä¸ªäººç®¡ç† CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ç”¨æˆ·æ³¨å†Œä¸ç™»å½•
- âœ… ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- âœ… ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹
- âœ… å¯†ç ä¿®æ”¹
- âœ… ç”¨æˆ·åˆ é™¤
- âœ… ç”¨æˆ·æœç´¢

---

## ğŸ” è®¤è¯æ–¹å¼

é™¤æ³¨å†Œå’Œç™»å½•æ¥å£å¤–ï¼Œæ‰€æœ‰æ¥å£éƒ½éœ€è¦åœ¨ Header ä¸­æºå¸¦è®¤è¯ä»¤ç‰Œï¼š

```
Authorization: Bearer <your_token>
```

---

## ğŸ“¡ æ¥å£è¯¦æƒ…

### 1. ç”¨æˆ·æ³¨å†Œ

**æ¥å£åï¼š** ç”¨æˆ·æ³¨å†Œ  
**è¯·æ±‚åœ°å€ï¼š** `/api/auth/register`  
**è¯·æ±‚æ–¹æ³•ï¼š** POST  
**å…¥å‚ï¼š**
```json
{
  "username": "string",
  "email": "string",
  "password": "string"
}
```
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "æ³¨å†ŒæˆåŠŸ",
  "user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "created_at": "string"
  }
}
```

---

### 2. ç”¨æˆ·ç™»å½•

**æ¥å£åï¼š** ç”¨æˆ·ç™»å½•  
**è¯·æ±‚åœ°å€ï¼š** `/api/auth/login`  
**è¯·æ±‚æ–¹æ³•ï¼š** POST  
**å…¥å‚ï¼š**
```json
{
  "username": "string",
  "password": "string"
}
```
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "ç™»å½•æˆåŠŸ",
  "token": "string",
  "user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "image_url": "string",
    "created_at": "string"
  }
}
```

---

### 3. ç”¨æˆ·ç™»å‡º

**æ¥å£åï¼š** ç”¨æˆ·ç™»å‡º  
**è¯·æ±‚åœ°å€ï¼š** `/api/auth/logout`  
**è¯·æ±‚æ–¹æ³•ï¼š** POST  
**å…¥å‚ï¼š** æ— ï¼ˆéœ€è¦ Authorization headerï¼‰  
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

---

### 4. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**æ¥å£åï¼š** è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯  
**è¯·æ±‚åœ°å€ï¼š** `/api/users/me`  
**è¯·æ±‚æ–¹æ³•ï¼š** GET  
**å…¥å‚ï¼š** æ— ï¼ˆéœ€è¦ Authorization headerï¼‰  
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "image_url": "string",
    "created_at": "string",
    "updated_at": "string"
  }
}
```

---

### 5. æ ¹æ®IDè·å–ç”¨æˆ·ä¿¡æ¯

**æ¥å£åï¼š** æ ¹æ®IDè·å–ç”¨æˆ·ä¿¡æ¯  
**è¯·æ±‚åœ°å€ï¼š** `/api/users/{user_id}`  
**è¯·æ±‚æ–¹æ³•ï¼š** GET  
**å…¥å‚ï¼š** 
- Pathå‚æ•°: `user_id` (string)
- Header: Authorization Bearer token

**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "image_url": "string",
    "created_at": "string",
    "updated_at": "string"
  }
}
```

---

### 6. è·å–ç”¨æˆ·åˆ—è¡¨

**æ¥å£åï¼š** è·å–ç”¨æˆ·åˆ—è¡¨  
**è¯·æ±‚åœ°å€ï¼š** `/api/users`  
**è¯·æ±‚æ–¹æ³•ï¼š** GET  
**å…¥å‚ï¼š**
- Queryå‚æ•°:
  - `skip`: integer (é»˜è®¤: 0) - è·³è¿‡çš„è®°å½•æ•°
  - `limit`: integer (é»˜è®¤: 20, æœ€å¤§: 100) - è¿”å›çš„è®°å½•æ•°
- Header: Authorization Bearer token

**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "users": [
    {
      "id": "string",
      "username": "string",
      "email": "string",
      "image_url": "string",
      "created_at": "string",
      "updated_at": "string"
    }
  ],
  "skip": 0,
  "limit": 20,
  "count": 10
}
```

---

### 7. æœç´¢ç”¨æˆ·

**æ¥å£åï¼š** æœç´¢ç”¨æˆ·  
**è¯·æ±‚åœ°å€ï¼š** `/api/users/search`  
**è¯·æ±‚æ–¹æ³•ï¼š** GET  
**å…¥å‚ï¼š**
- Queryå‚æ•°:
  - `keyword`: string (å¿…å¡«) - æœç´¢å…³é”®è¯
  - `skip`: integer (é»˜è®¤: 0)
  - `limit`: integer (é»˜è®¤: 20, æœ€å¤§: 100)
- Header: Authorization Bearer token

**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "users": [
    {
      "id": "string",
      "username": "string",
      "email": "string",
      "image_url": "string",
      "created_at": "string",
      "updated_at": "string"
    }
  ],
  "keyword": "string",
  "count": 5
}
```

---

### 8. æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯

**æ¥å£åï¼š** æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯  
**è¯·æ±‚åœ°å€ï¼š** `/api/users/me`  
**è¯·æ±‚æ–¹æ³•ï¼š** PUT  
**å…¥å‚ï¼š**
```json
{
  "username": "string (å¯é€‰)",
  "email": "string (å¯é€‰)",
  "image_url": "string (å¯é€‰)"
}
```
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "æ›´æ–°æˆåŠŸ",
  "user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "image_url": "string",
    "created_at": "string",
    "updated_at": "string"
  }
}
```

---

### 9. ä¿®æ”¹å½“å‰ç”¨æˆ·å¯†ç 

**æ¥å£åï¼š** ä¿®æ”¹å½“å‰ç”¨æˆ·å¯†ç   
**è¯·æ±‚åœ°å€ï¼š** `/api/users/me/password`  
**è¯·æ±‚æ–¹æ³•ï¼š** PUT  
**å…¥å‚ï¼š**
```json
{
  "old_password": "string",
  "new_password": "string"
}
```
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "å¯†ç ä¿®æ”¹æˆåŠŸ"
}
```

---

### 10. åˆ é™¤å½“å‰ç”¨æˆ·è´¦å·

**æ¥å£åï¼š** åˆ é™¤å½“å‰ç”¨æˆ·è´¦å·  
**è¯·æ±‚åœ°å€ï¼š** `/api/users/me`  
**è¯·æ±‚æ–¹æ³•ï¼š** DELETE  
**å…¥å‚ï¼š** æ— ï¼ˆéœ€è¦ Authorization headerï¼‰  
**å‡ºå‚ï¼š**
```json
{
  "status": "success",
  "message": "è´¦å·å·²åˆ é™¤"
}
```

---

## ğŸ”´ é”™è¯¯å“åº”

æ‰€æœ‰æ¥å£åœ¨å‡ºé”™æ—¶è¿”å›æ ‡å‡†çš„ HTTP é”™è¯¯çŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯ï¼š

```json
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

å¸¸è§é”™è¯¯ç ï¼š
- `400 Bad Request` - è¯·æ±‚å‚æ•°é”™è¯¯ï¼ˆå¦‚ç”¨æˆ·åå·²å­˜åœ¨ã€é‚®ç®±å·²å­˜åœ¨ç­‰ï¼‰
- `401 Unauthorized` - æœªè®¤è¯æˆ–ä»¤ç‰Œæ— æ•ˆ
- `404 Not Found` - èµ„æºä¸å­˜åœ¨ï¼ˆå¦‚ç”¨æˆ·ä¸å­˜åœ¨ï¼‰
- `422 Unprocessable Entity` - è¯·æ±‚æ ¼å¼é”™è¯¯
- `500 Internal Server Error` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹å¼1: ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬

```bash
python server/test_user_crud.py
```

### æ–¹å¼2: ä½¿ç”¨ curl å‘½ä»¤

```bash
# 1. æ³¨å†Œç”¨æˆ·
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"password123"}'

# 2. ç™»å½•
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 3. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦æ›¿æ¢ YOUR_TOKENï¼‰
curl -X GET http://localhost:8000/api/users/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### æ–¹å¼3: ä½¿ç”¨ Postman æˆ–å…¶ä»– API æµ‹è¯•å·¥å…·

å¯¼å…¥ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š
- `BASE_URL`: http://localhost:8000
- `TOKEN`: ç™»å½•åè·å–çš„ token

---

## ğŸ“¦ æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | TEXT PRIMARY KEY | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| username | TEXT UNIQUE | ç”¨æˆ·å |
| email | TEXT UNIQUE | é‚®ç®± |
| password_hash | TEXT | å¯†ç å“ˆå¸Œå€¼ |
| image_url | TEXT | å¤´åƒURL |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ |
| updated_at | TEXT | æ›´æ–°æ—¶é—´ |

### auth_tokens è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| token | TEXT PRIMARY KEY | ä»¤ç‰Œ |
| user_id | TEXT | ç”¨æˆ·ID |
| expires_at | TEXT | è¿‡æœŸæ—¶é—´ |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ |

---

## ğŸ”§ æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: FastAPI
- **æ•°æ®åº“**: SQLite (aiosqlite)
- **å¯†ç åŠ å¯†**: SHA-256
- **è®¤è¯æ–¹å¼**: Token-based
- **æ—¥å¿—**: è‡ªå®šä¹‰ logger

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¯†ç å®‰å…¨**: æ‰€æœ‰å¯†ç ä½¿ç”¨ SHA-256 è¿›è¡Œå“ˆå¸Œå­˜å‚¨
2. **ä»¤ç‰Œè¿‡æœŸ**: è®¿é—®ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸä¸º 7 å¤©
3. **åˆ†é¡µé™åˆ¶**: åˆ—è¡¨æ¥å£å•æ¬¡æœ€å¤šè¿”å› 100 æ¡è®°å½•
4. **é‚®ç®±éªŒè¯**: æ³¨å†Œæ—¶ä¼šéªŒè¯é‚®ç®±æ ¼å¼
5. **ç”¨æˆ·åå”¯ä¸€**: ç”¨æˆ·åå’Œé‚®ç®±å¿…é¡»å”¯ä¸€
6. **è½¯åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶ä¼šåŒæ—¶åˆ é™¤ç›¸å…³çš„ token å’Œè®¾å¤‡ç 

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. å¯åŠ¨åç«¯æœåŠ¡ï¼š
```bash
cd server
python main.py
```

2. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
python server/test_user_crud.py
```

3. æŸ¥çœ‹ API æ–‡æ¡£ï¼š
è®¿é—® http://localhost:8000/docs
